<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Multi-User Earnings App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="ico.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-image: url('https://images.unsplash.com/photo-1582494764392-f12d4653b6a2?q=80&w=1974&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; }
        .calculator-card { background-color: rgba(255, 255, 255, 0.97); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .form-input:focus, .form-select:focus { --tw-ring-color: #4f46e5; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .dynamic-row, .module-container { animation: fadeIn 0.4s ease-out; }
        .module-manager-label { display: flex; align-items: center; cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .module-manager-label:hover { background-color: rgba(0,0,0,0.05); }
        .module-manager-label input { margin-right: 0.75rem; }
        .credit-text { text-shadow: 1px 1px 3px rgba(0,0,0,0.6); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2 sm:p-4 gap-4">

    <header class="text-center">
        <h1 class="text-xl sm:text-2xl font-bold text-white/90 credit-text">Earnings Tracker</h1>
    </header>

    <div class="calculator-card w-full max-w-3xl rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 space-y-6 md:space-y-8">
        
        <div class="text-center">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900">Multi-User Earnings App</h1>
            <p class="text-gray-600 mt-2 text-sm sm:text-base">Track and save earnings for multiple users.</p>
        </div>

        <div id="calculator" class="space-y-6 md:space-y-8">
            
            <div>
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">User Profile</h2>
                <div class="p-3 bg-gray-50/50 rounded-lg border">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-medium text-gray-600">Select User</label>
                            <select id="userSelect" class="form-select w-full p-2 mt-1 border-gray-300 rounded-md focus:ring-1"></select>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600">Delete Selected User</label>
                            <button id="deleteUserBtn" type="button" class="w-full mt-1 p-2 text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">Delete User</button>
                        </div>
                    </div>
                    <div class="mt-3 border-t pt-3">
                        <label class="text-xs font-medium text-gray-600">Create New User</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="newUserName" placeholder="Enter new user name" class="form-input w-full p-2 border-gray-300 rounded-md focus:ring-1">
                            <button id="addUserBtn" type="button" class="p-2 text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">Add User</button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Customize Calculator Sections</h2>
                <div id="moduleManager" class="p-3 bg-gray-50/50 rounded-lg border grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
                    </div>
            </div>

            <div>
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">1. Select Day to Edit</h2>
                <div class="flex gap-2">
                    <select id="dayOfMonth" class="form-select w-full p-3 bg-gray-50/50 border border-gray-300 rounded-lg focus:ring-2 transition"></select>
                    <button id="clearDayBtn" type="button" class="p-3 text-white bg-gray-500 hover:bg-gray-600 rounded-lg transition-colors" title="Clear All Data for Selected Day">Clear Day</button>
                </div>
            </div>
            
            <div id="main-content" class="space-y-6 md:space-y-8">
                <div>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">2. Stone Sales (Earnings)</h2>
                    <div id="stoneSalesList" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 p-3 bg-gray-50/50 rounded-lg border">
                            <label class="md:col-span-1 flex items-center text-base sm:text-lg font-medium text-gray-800">6 Feet Stones</label>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Quantity Sold</label><input type="number" data-field="q6" value="0" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Sale Price (₹)</label><input type="number" data-field="p6" value="100" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 p-3 bg-gray-50/50 rounded-lg border">
                            <label class="md:col-span-1 flex items-center text-base sm:text-lg font-medium text-gray-800">7 Feet Stones</label>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Quantity Sold</label><input type="number" data-field="q7" value="0" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Sale Price (₹)</label><input type="number" data-field="p7" value="110" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 p-3 bg-gray-50/50 rounded-lg border">
                            <label class="md:col-span-1 flex items-center text-base sm:text-lg font-medium text-gray-800">8 Feet Stones</label>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Quantity Sold</label><input type="number" data-field="q8" value="0" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Sale Price (₹)</label><input type="number" data-field="p8" value="120" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                        </div>
                    </div>
                </div>

                <div id="moduleContainer-chainLinkFt" class="module-container" style="display: none;">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Chain Link Sales (per Foot)</h2>
                    <div id="chainLinksList" class="space-y-3"></div>
                    <button id="addChainLinkBtn" type="button" class="mt-3 w-full flex items-center justify-center gap-2 p-2 text-sm font-semibold text-blue-600 bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        Add Sale (per Foot)
                    </button>
                </div>

                <div id="moduleContainer-chainLinkRoll" class="module-container" style="display: none;">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Chain Link Sales (per Roll)</h2>
                    <div id="chainLinkRollsList" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 p-3 bg-gray-50/50 rounded-lg border">
                            <label class="md:col-span-1 flex items-center text-base sm:text-lg font-medium text-gray-800">4ft Rolls (100ft)</label>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Quantity of Rolls</label><input type="number" data-field="q4" value="0" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Sale Price/Roll (₹)</label><input type="number" data-field="p4" value="3000" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 p-3 bg-gray-50/50 rounded-lg border">
                            <label class="md:col-span-1 flex items-center text-base sm:text-lg font-medium text-gray-800">5ft Rolls (100ft)</label>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Quantity of Rolls</label><input type="number" data-field="q5" value="0" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Sale Price/Roll (₹)</label><input type="number" data-field="p5" value="4000" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 p-3 bg-gray-50/50 rounded-lg border">
                            <label class="md:col-span-1 flex items-center text-base sm:text-lg font-medium text-gray-800">6ft Rolls (100ft)</label>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Quantity of Rolls</label><input type="number" data-field="q6" value="0" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                            <div><label class="text-xs sm:text-sm font-medium text-gray-600">Sale Price/Roll (₹)</label><input type="number" data-field="p6" value="5000" min="0" class="form-input w-full mt-1 p-2 border-gray-300 rounded-md focus:ring-1"></div>
                        </div>
                    </div>
                </div>

                <div id="moduleContainer-otherEarnings" class="module-container" style="display: none;">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Other Earnings (Additions)</h2>
                    <div id="otherEarningsList" class="space-y-3"></div>
                    <button id="addEarningBtn" type="button" class="mt-3 w-full flex items-center justify-center gap-2 p-2 text-sm font-semibold text-green-600 bg-green-100 hover:bg-green-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        Add Earning
                    </button>
                </div>

                <div id="moduleContainer-deductions" class="module-container" style="display: none;">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Deductions / Donations (Payouts)</h2>
                    <div id="deductionsList" class="space-y-3"></div>
                    <button id="addDeductionBtn" type="button" class="mt-3 w-full flex items-center justify-center gap-2 p-2 text-sm font-semibold text-red-600 bg-red-100 hover:bg-red-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z" clip-rule="evenodd" /></svg>
                        Add Deduction
                    </button>
                </div>

                <div>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Owner Payouts</h2>
                    <div id="ownersList" class="space-y-3"></div>
                    <button id="addOwnerBtn" type="button" class="mt-3 w-full flex items-center justify-center gap-2 p-2 text-sm font-semibold text-indigo-600 bg-indigo-100 hover:bg-indigo-200 rounded-lg transition-colors">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        Add Owner Payout
                    </button>
                </div>

                <div class="bg-gray-800 text-white rounded-lg p-4 sm:p-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div><p class="text-sm sm:text-base text-gray-400 font-semibold">Day's Gross Earnings</p><p id="grossEarningsDisplay" class="text-xl sm:text-2xl font-bold text-green-400 mt-1">₹0.00</p></div>
                    <div class="border-t pt-4 md:border-t-0 md:pt-0 md:border-l md:border-r border-gray-600 md:px-4"><p class="text-sm sm:text-base text-gray-400 font-semibold">Day's Total Payouts</p><p id="totalPayoutsDisplay" class="text-xl sm:text-2xl font-bold text-red-400 mt-1">₹0.00</p></div>
                    <div><p class="text-sm sm:text-base text-gray-400 font-semibold">Day's Net Earnings</p><p id="netEarningsDisplay" class="text-2xl sm:text-3xl font-bold text-white mt-1">₹0.00</p></div>
                </div>

                <div class="bg-indigo-800 text-white rounded-lg p-4 sm:p-6 text-center space-y-4">
                    <div>
                        <p class="text-lg sm:text-xl font-semibold">Total Monthly Salary (Net)</p>
                        <p id="monthlySalaryDisplay" class="text-3xl sm:text-4xl md:text-5xl font-bold mt-2">₹0.00</p>
                    </div>
                    <div class="border-t border-indigo-600 pt-4">
                        <label class="text-sm font-medium">Divide Monthly Salary By</label>
                        <div class="flex justify-center items-center gap-2 mt-2">
                            <input type="number" id="divideByInput" value="1" min="1" class="form-input w-24 p-2 text-center text-black rounded-md">
                            <span class="text-lg font-medium">People</span>
                        </div>
                        <p class="text-lg sm:text-xl font-semibold mt-3">Salary Per Person</p>
                        <p id="salaryPerPersonDisplay" class="text-2xl sm:text-3xl font-bold text-green-300 mt-1">₹0.00</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center">
        <p class="text-sm text-white/80 credit-text">
            Created & All Rights Reserved by SANTHOSH_A &copy; 2025
        </p>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM ELEMENTS ---
    const userSelect = document.getElementById('userSelect');
    const addUserBtn = document.getElementById('addUserBtn');
    const newUserNameInput = document.getElementById('newUserName');
    const deleteUserBtn = document.getElementById('deleteUserBtn');
    const dayOfMonthSelect = document.getElementById('dayOfMonth');
    const mainContent = document.getElementById('main-content');
    const divideByInput = document.getElementById('divideByInput');
    const moduleManagerContainer = document.getElementById('moduleManager');

    // --- APP STATE AND CONSTANTS ---
    const APP_BASE_PREFIX = 'modularEarningsApp';
    let currentUser = null;
    let currentDay = 1;

    const MODULES = {
        chainLinkFt: { name: 'Chain Link (per Ft)', enabled: true },
        chainLinkRoll: { name: 'Chain Link (per Roll)', enabled: false },
        otherEarnings: { name: 'Other Earnings', enabled: true },
        deductions: { name: 'Deductions', enabled: false },
    };

    // --- USER & SETTINGS MANAGEMENT ---
    const getUsers = () => JSON.parse(localStorage.getItem(`${APP_BASE_PREFIX}_users`)) || [];
    const saveUsers = (users) => localStorage.setItem(`${APP_BASE_PREFIX}_users`, JSON.stringify(users));
    const getSettingsKey = () => `${APP_BASE_PREFIX}_${currentUser}_settings`;
    const getUserSettings = () => {
        if (!currentUser) return MODULES;
        const saved = JSON.parse(localStorage.getItem(getSettingsKey()));
        // Merge with defaults to ensure new modules are added for existing users
        return saved ? { ...MODULES, ...saved } : MODULES;
    };
    const saveUserSettings = (settings) => {
        if (!currentUser) return;
        localStorage.setItem(getSettingsKey(), JSON.stringify(settings));
    };
    
    const populateUserSelect = () => {
        const users = getUsers();
        userSelect.innerHTML = '';
        if (users.length === 0) {
            userSelect.innerHTML = '<option>No users found. Add one!</option>';
            mainContent.style.display = 'none';
            moduleManagerContainer.parentElement.style.display = 'none';
            return;
        }
        mainContent.style.display = 'block';
        moduleManagerContainer.parentElement.style.display = 'block';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            userSelect.appendChild(option);
        });
    };

    const switchUser = (userName) => {
        currentUser = userName;
        localStorage.setItem(`${APP_BASE_PREFIX}_lastUser`, userName);
        if (userSelect.value !== userName) userSelect.value = userName;
        applyModuleSettings();
        loadData();
    };

    addUserBtn.addEventListener('click', () => {
        const newName = newUserNameInput.value.trim();
        if (!newName) return alert('Please enter a user name.');
        let users = getUsers();
        if (users.includes(newName)) return alert('User already exists.');
        users.push(newName);
        saveUsers(users);
        populateUserSelect();
        newUserNameInput.value = '';
        switchUser(newName);
    });

    deleteUserBtn.addEventListener('click', () => {
        if (!currentUser) return;
        if (confirm(`Are you sure you want to delete user "${currentUser}" and all their data? This cannot be undone.`)) {
            let users = getUsers();
            users = users.filter(u => u !== currentUser);
            saveUsers(users);
            // Delete all associated data
            Object.keys(localStorage)
                .filter(key => key.startsWith(`${APP_BASE_PREFIX}_${currentUser}`))
                .forEach(key => localStorage.removeItem(key));
            populateUserSelect();
            switchUser(getUsers()[0] || null);
        }
    });

    userSelect.addEventListener('change', () => {
        if (currentUser) saveData();
        switchUser(userSelect.value);
    });

    // --- MODULE MANAGEMENT ---
    const applyModuleSettings = () => {
        const settings = getUserSettings();
        for (const key in MODULES) { // Iterate over master list to avoid errors with old settings
            const isEnabled = settings[key] ? settings[key].enabled : MODULES[key].enabled;
            const container = document.getElementById(`moduleContainer-${key}`);
            const toggle = document.getElementById(`module-toggle-${key}`);
            if (container) container.style.display = isEnabled ? 'block' : 'none';
            if (toggle) toggle.checked = isEnabled;
        }
        calculateAndDisplay();
    };

    const populateModuleManager = () => {
        moduleManagerContainer.innerHTML = '';
        const settings = getUserSettings();
        for (const key in MODULES) {
            const label = document.createElement('label');
            label.className = 'module-manager-label text-sm';
            label.innerHTML = `<input type="checkbox" id="module-toggle-${key}" data-module="${key}"> ${MODULES[key].name}`;
            moduleManagerContainer.appendChild(label);
        }
    };

    moduleManagerContainer.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
            const key = e.target.dataset.module;
            const settings = getUserSettings();
            if(!settings[key]) settings[key] = { name: MODULES[key].name, enabled: false };
            settings[key].enabled = e.target.checked;
            saveUserSettings(settings);
            applyModuleSettings();
        }
    });

    // --- DATA HANDLING ---
    const getDataKey = () => `${APP_BASE_PREFIX}_${currentUser}_day_${currentDay}`;

    const getFormData = () => {
        if (!currentUser) return null;
        const settings = getUserSettings();
        const data = { stones: {} };
        
        document.querySelectorAll('#stoneSalesList input[type="number"]').forEach(input => data.stones[input.dataset.field] = input.value);

        if(settings.chainLinkFt?.enabled) {
            data.chainLinks = [];
            document.querySelectorAll('#chainLinksList .dynamic-row').forEach(row => data.chainLinks.push({ height: row.querySelector('[data-field="height"]').value, length: row.querySelector('[data-field="length"]').value, price: row.querySelector('[data-field="price"]').value }));
        }
        if(settings.chainLinkRoll?.enabled) {
            data.chainLinkRolls = {};
            document.querySelectorAll('#chainLinkRollsList input[type="number"]').forEach(input => data.chainLinkRolls[input.dataset.field] = input.value);
        }
        if(settings.otherEarnings?.enabled) {
            data.otherEarnings = [];
            document.querySelectorAll('#otherEarningsList .dynamic-row').forEach(row => data.otherEarnings.push({ name: row.querySelector('[data-field="name"]').value, amount: row.querySelector('[data-field="amount"]').value }));
        }
        if(settings.deductions?.enabled) {
            data.deductions = [];
            document.querySelectorAll('#deductionsList .dynamic-row').forEach(row => data.deductions.push({ name: row.querySelector('[data-field="name"]').value, amount: row.querySelector('[data-field="amount"]').value }));
        }
        data.owners = [];
        document.querySelectorAll('#ownersList .dynamic-row').forEach(row => data.owners.push({ name: row.querySelector('[data-field="name"]').value, amount: row.querySelector('[data-field="amount"]').value }));
        
        return data;
    };

    const saveData = () => {
        if (!currentUser) return;
        localStorage.setItem(getDataKey(), JSON.stringify(getFormData()));
    };

    const loadData = () => {
        currentDay = dayOfMonthSelect.value;
        clearForm();
        if (!currentUser) return calculateAndDisplay();
        
        const dataString = localStorage.getItem(getDataKey());
        if (dataString) {
            const data = JSON.parse(dataString);
            if (data.stones) for (const key in data.stones) document.querySelector(`#stoneSalesList [data-field="${key}"]`).value = data.stones[key];
            if (data.chainLinkRolls) for (const key in data.chainLinkRolls) document.querySelector(`#chainLinkRollsList [data-field="${key}"]`).value = data.chainLinkRolls[key];
            data.chainLinks?.forEach(item => addChainLinkRow(item));
            data.otherEarnings?.forEach(item => addEarningRow(item));
            data.deductions?.forEach(item => addDeductionRow(item));
            data.owners?.forEach(item => addOwnerRow(item));
        }
        calculateAndDisplay();
    };

    const clearForm = () => {
        document.querySelectorAll('#stoneSalesList input[type="number"], #chainLinkRollsList input[type="number"]').forEach(input => {
            const field = input.dataset.field;
            if (field.startsWith('q')) input.value = '0';
            else if (field === 'p6' && input.closest('#stoneSalesList')) input.value = '100'; 
            else if (field === 'p7') input.value = '110'; else if (field === 'p8') input.value = '120';
            else if (field === 'p4') input.value = '3000'; else if (field === 'p5') input.value = '4000'; else if (field === 'p6' && input.closest('#chainLinkRollsList')) input.value = '5000';
        });
        document.getElementById('chainLinksList').innerHTML = '';
        document.getElementById('otherEarningsList').innerHTML = '';
        document.getElementById('deductionsList').innerHTML = '';
        document.getElementById('ownersList').innerHTML = '';
    };

    // --- DYNAMIC ROW CREATION ---
    const createRow = (list, innerHTML, data) => {
        const row = document.createElement('div');
        row.className = 'dynamic-row grid grid-cols-1 sm:grid-cols-12 gap-2 items-center p-2 bg-gray-50/50 rounded-lg border';
        row.innerHTML = innerHTML;
        if (data) for (const key in data) {
            const input = row.querySelector(`[data-field="${key}"]`);
            if (input) input.value = data[key];
        }
        list.appendChild(row);
    };

    const removeBtnHTML = `<button type="button" class="remove-btn p-2 text-red-500 bg-red-100 hover:bg-red-200 rounded-md"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/></svg></button>`;
    const addChainLinkRow = (data = {}) => createRow(document.getElementById('chainLinksList'), `<div class="sm:col-span-4"><label class="text-xs font-medium text-gray-500">Height</label><select data-field="height" class="form-select w-full p-2 text-sm border-gray-300 rounded-md"><option value="5">5 feet</option><option value="6">6 feet</option></select></div><div class="sm:col-span-3"><label class="text-xs font-medium text-gray-500">Length (ft)</label><input data-field="length" type="number" value="1" min="1" class="form-input w-full p-2 text-sm border-gray-300 rounded-md"></div><div class="sm:col-span-3"><label class="text-xs font-medium text-gray-500">Price/ft (₹)</label><input data-field="price" type="number" value="20" min="0" class="form-input w-full p-2 text-sm border-gray-300 rounded-md"></div><div class="sm:col-span-2 text-right"><label class="text-xs font-medium text-gray-500 hidden sm:block">&nbsp;</label>${removeBtnHTML}</div>`, data);
    const addEarningRow = (data = {}) => createRow(document.getElementById('otherEarningsList'), `<div class="sm:col-span-5"><label class="text-xs font-medium text-gray-500">Earning Source</label><input data-field="name" type="text" placeholder="e.g. Scrap Sale" class="form-input w-full p-2 text-sm border-gray-300 rounded-md"></div><div class="sm:col-span-5"><label class="text-xs font-medium text-gray-500">Amount (₹)</label><input data-field="amount" type="number" value="0" min="0" class="form-input w-full p-2 text-sm border-gray-300 rounded-md"></div><div class="sm:col-span-2 text-right"><label class="text-xs font-medium text-gray-500 hidden sm:block">&nbsp;</label>${removeBtnHTML}</div>`, data);
    const addDeductionRow = (data = {}) => createRow(document.getElementById('deductionsList'), `<div class="sm:col-span-5"><label class="text-xs font-medium text-gray-500">Deduction Name</label><input data-field="name" type="text" placeholder="e.g. Temple Fund" class="form-input w-full p-2 text-sm border-gray-300 rounded-md"></div><div class="sm:col-span-5"><label class="text-xs font-medium text-gray-500">Amount (₹)</label><input data-field="amount" type="number" value="0" min="0" class="form-input w-full p-2 text-sm border-gray-300 rounded-md"></div><div class="sm:col-span-2 text-right"><label class="text-xs font-medium text-gray-500 hidden sm:block">&nbsp;</label>${removeBtnHTML}</div>`, data);
    const addOwnerRow = (data = {}) => createRow(document.getElementById('ownersList'), `<div class="sm:col-span-5"><label class="text-xs font-medium text-gray-500">Owner Name</label><input data-field="name" type="text" placeholder="e.g. SANTHOSH_A" class="form-input w-full p-2 text-sm border-gray-300 rounded-md"></div><div class="sm:col-span-5"><label class="text-xs font-medium text-gray-500">Payout (₹)</label><input data-field="amount" type="number" value="0" min="0" class="form-input w-full p-2 text-sm border-gray-300 rounded-md"></div><div class="sm:col-span-2 text-right"><label class="text-xs font-medium text-gray-500 hidden sm:block">&nbsp;</label>${removeBtnHTML}</div>`, data);

    // --- CALCULATION LOGIC ---
    const formatCurrency = (amount) => `₹${amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

    const calculateDayTotals = (data) => {
        if (!data) return { gross: 0, payouts: 0, net: 0 };
        let gross = 0, payouts = 0;
        
        gross += (parseFloat(data.stones.q6) || 0) * (parseFloat(data.stones.p6) || 0);
        gross += (parseFloat(data.stones.q7) || 0) * (parseFloat(data.stones.p7) || 0);
        gross += (parseFloat(data.stones.q8) || 0) * (parseFloat(data.stones.p8) || 0);
        
        data.chainLinks?.forEach(item => gross += (parseFloat(item.length) || 0) * (parseFloat(item.price) || 0));
        if (data.chainLinkRolls) {
            gross += (parseFloat(data.chainLinkRolls.q4) || 0) * (parseFloat(data.chainLinkRolls.p4) || 0);
            gross += (parseFloat(data.chainLinkRolls.q5) || 0) * (parseFloat(data.chainLinkRolls.p5) || 0);
            gross += (parseFloat(data.chainLinkRolls.q6) || 0) * (parseFloat(data.chainLinkRolls.p6) || 0);
        }
        data.otherEarnings?.forEach(item => gross += parseFloat(item.amount) || 0);
        
        data.deductions?.forEach(item => payouts += parseFloat(item.amount) || 0);
        data.owners?.forEach(item => payouts += parseFloat(item.amount) || 0);
        
        return { gross, payouts, net: gross - payouts };
    };

    const calculateAndDisplay = () => {
        const dayTotals = calculateDayTotals(getFormData());
        document.getElementById('grossEarningsDisplay').textContent = formatCurrency(dayTotals.gross);
        document.getElementById('totalPayoutsDisplay').textContent = formatCurrency(dayTotals.payouts);
        document.getElementById('netEarningsDisplay').textContent = formatCurrency(dayTotals.net);
        calculateMonthlyTotal();
    };

    const calculateMonthlyTotal = () => {
        let monthlyNet = 0;
        if (currentUser) {
            for (let i = 1; i <= 31; i++) {
                const dataString = localStorage.getItem(`${APP_BASE_PREFIX}_${currentUser}_day_${i}`);
                if (dataString) monthlyNet += calculateDayTotals(JSON.parse(dataString)).net;
            }
        }
        document.getElementById('monthlySalaryDisplay').textContent = formatCurrency(monthlyNet);
        const divideBy = parseInt(divideByInput.value, 10);
        document.getElementById('salaryPerPersonDisplay').textContent = formatCurrency(divideBy > 0 ? monthlyNet / divideBy : 0);
    };

    // --- EVENT LISTENERS ---
    for (let i = 1; i <= 31; i++) dayOfMonthSelect.appendChild(new Option(`Day ${i}`, i));
    
    dayOfMonthSelect.addEventListener('change', () => { saveData(); loadData(); });
    document.getElementById('calculator').addEventListener('input', () => { saveData(); calculateAndDisplay(); });
    
    document.getElementById('addChainLinkBtn').addEventListener('click', () => addChainLinkRow());
    document.getElementById('addEarningBtn').addEventListener('click', () => addEarningRow());
    document.getElementById('addDeductionBtn').addEventListener('click', () => addDeductionRow());
    document.getElementById('addOwnerBtn').addEventListener('click', () => addOwnerRow());

    document.getElementById('calculator').addEventListener('click', (e) => {
        if (e.target.closest('.remove-btn')) {
            e.target.closest('.dynamic-row').remove();
            saveData();
            calculateAndDisplay();
        }
    });

    document.getElementById('clearDayBtn').addEventListener('click', () => {
        if (currentUser && confirm(`Are you sure you want to delete all data for Day ${currentDay} for user "${currentUser}"?`)) {
            localStorage.removeItem(getDataKey());
            loadData();
        }
    });

    // --- INITIALIZATION ---
    populateUserSelect();
    populateModuleManager();
    const lastUser = localStorage.getItem(`${APP_BASE_PREFIX}_lastUser`);
    const initialUser = getUsers().includes(lastUser) ? lastUser : getUsers()[0] || null;
    if (initialUser) {
        switchUser(initialUser);
    }
});
</script>

</body>
</html>